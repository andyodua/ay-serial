ymfile
======

Модуль для загрузки .ym-файлов. Экспортирует следующие объекты:

_ymfile.**supported_formats**_ — кортеж поддерживаемых форматов (сигнатуры файлов). На данный момент поддерживаются два формата — **'YM5!'** и **'YM6!'**.

_ymfile.**header**_ — описание структуры заголовка файла в виде кортежа кортежей. Используется ```ymfile.load()``` при парсинге файла.

_ymfile.**YMFileException**_ — исключение. Вызывается при ошибках в  ```ymfile.load()```.

_ymfile.**read_str**(fo, length=None, encoding='ascii')_ — прочитать из file-like object ```fo``` (например, открытый в режиме 'rb' файл) строку длиной ```length``` байтов. Если ```length``` не указана или **False** в логическом контексте, то читать до байта **0x00** (**null-terminated string**) или конца файла. Дополнительно можно указать кодировку ```encoding```. Для многобайтовых кодировок необходимо учитывать, что ```length``` указывается в **байтах**.

_ymfile.**read_int**(fo, length, byteorder='big')_ — прочитать из file-like object ```fo``` число длиной 		```length``` байтов и порядком байтов ```byreorder``` (**'big'** или **'little'**).

_ymfile.**load**(fo)_ — прочитать .ym-файл из file-like object ```fo```. Файл может быть сжат с помощью **LHA**, для распаковки требуется модуль **[lhafile][1]** (сжатый файл определяется по фрагменту сигнатуры **'-lh'**). В случае успеха возвращает словарь со следующими ключами:

* str ```file_id``` — сигнатура файла (например, **'YM6!'**).
* str ```check_string``` — проверочная строка. Для YM6 должна быть **'LeOnArD!'**.
* int ```frames``` — количество фреймов в файле.
* int ```attributes``` — атрибуты в виде 32-битного числа. Из спецификации:
  * **b0**: Set if Interleaved data block.
  * **b1**: Set if the digi-drum samples are signed data.
  * **b2**: Set if the digidrum is already in ST 4 bits format.
  * **b3-b31**: Not used yet, MUST BE 0.
* int ```digidrums``` — количество **digidrum** семплов (при парсинге они игнорируются).
* int ```clock``` — частота AY/YM в Гц. Например, 2000000 для Atari ST, 1773400 для оригинального ZX Spectrum.
* int ```frame_freq``` — частота фреймов в Гц (обычно 50 Гц).
* int ```loop_frame``` — номер фрейма для зацикленного воспроизведения. Например, при **0** трек будет проигрываться по кругу с начала.
* str ```song_name``` — название трека.
* str ```author``` — автор трека.
* str ```comment``` — комментарий.
* int ```length``` — продолжительность трека в секундах, вычисленная как round(```frames``` / ```frame_freq```).
* bool ```interleaved``` — **True**, если фреймы хранятся в чередующемся порядке (нулевой бит ```attributes```).
* bool ```compressed``` — **True**, если файл сжат с помощью **LHA**.
* str ```compressed_filename``` — (только для сжатых файлов) оригинальное имя файла (внутри архива).
* list ```data``` — данные фреймов в виде списка байтов (объектов **bytes**). Формат хранения зависит от режима — чередующийся или нет (см. ```interleaved```).
  * для обычного режима — [фрейм0, фрейм1, …, фреймN]. Каждый фрейм — объект **bytes** длиной 16 байтов (дамп регистров). Количество фреймов соответствует ```frames```.
  * для чередующегося режима — [регистр0, регистр1, …, регистр15]. Каждый регистр — объект **bytes** длиной ```frames```, каждый байт N регистра соответствует значению этого регистра во фрейме N.

```ymfile.load()``` вызывает исключение ```ymfile.YMFileException``` в следующих случаях:

* *Compressed file; install 'lhafile'* — файл сжат с помошью **LHA**, но модуль **[lhafile][1]** не найден.
* *Unsupported format* — сигнатура файла не соответствует поддерживаемым форматам (см. ```ymfile.supported_formats```).
* *Truncated file* — размер блока с фреймами меньше ожидаемого (```frames``` * 16).
* *Wrong end marker* — неправильный/отсутствующий маркер конца файла (должен быть **'End!'**).

```ymfile.load()``` не обрабатывает исключения (например, при чтении из файла) — их необходимо перехватывать в вызывающем коде.

_ymfile.**get_frame**(data, frame, interleaved=True)_ — извлечь фрейм номер ```frame``` из ```data``` (данные фреймов в списке, возвращаемом ```ymfile.load()``` в словаре под ключом ```data```). Флаг  ```interleaved``` указывает на формат хранения фреймов в ```data```. Корректность номера фрейма не проверяется, выход за границы вызовет **IndexError**. Фрейм возвращается в виде объекта **bytes** длиной 16 байтов.


### Пример использования:

```python
import ymfile
with open('file.ym', 'rb') as f:
    try:
        ym = ymfile.load(f)
    except ymfile.YMFileException as e:
        print("Error:", e)
    else:
        print("Track", ym['song_name'], "by", ym['author'])
        first_frame = ymfile.get_frame(ym['data'], 0, ym['interleaved'])
        print(first_frame)
```


[1]: http://fengestad.no/python-lhafile/
