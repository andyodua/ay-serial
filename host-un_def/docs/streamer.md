AY-serial streamer
==================

Скрипт на Python 3 для проигрывания .ym-файлов. Использует модуль ```ymfile```.

### Использование

```streamer.py -p port [-b bd] [-u] [-l] [-v] file.ym```

```-h```, ```--help``` — показать помощь.

```-p```, ```--port``` — 	устройство последовательного порта (например, **COM6**, **/dev/ttyUSB0** и т.п.). Обязательный аргумент.

```-b```, ```--baudrate``` — скорость последовательного порта (по умолчанию **38400**).

```-u```, ```--unbuf``` — использовать небуферизированный режим работы (см. ниже).

```-l```, ```--loop``` — зацикленное воспроизведение (после окончания трека переход на ```loop_frame```, указанный в заголовке файла).

```-v```, ```--verbose``` — показать всю информацию о файле, возвращаемую ```ymfile.load()```, в виде **ключ: значение**. По умолчанию отображается только название трека, автор, комментарий и продолжительность (в форматированном виде).

### Режимы работы

Поддержка режимов зависит от прошивки устройства.

##### Буферизированный
Режим по умолчанию. Ожидание запроса данных от устройства (байт **0x08**), по запросу отправка 256 байтов (16 фреймов). Тактование осуществляется самим устройством, которое хранит фреймы в своём кольцевом буфере и запрашивает новые данные по мере необходимости.

##### Небуферизированный
Включается ключом ```-u``` / ```--unbuf```. Устройство не запрашивает данные, скрипт отправляет фреймы (16 байтов) по одному с задержкой между ними в 1/```frame_freq``` секунд (при частоте 50 Гц — 0.02 с).

### О реализации режимов
В небуферизированном режиме при обычном воспроизведении после последнего фрейма отправляется один пустой фрейм (16 байтов **0x00**), чтобы приглушить AY, и работа скрипта завершается. При зацикленном воспроизведении осуществяется переход на ```loop_frame``` (указан в заголовке файла). Если ```loop_frame``` = 0, то воспроизведение начнётся с начала файла.

В буферизированном режиме при обычном воспроизведении блок с последним фреймом заполняется нулевыми байтами до размера в 256 байтов  (в случае необходимости, т.е. когда общее количество фреймов в файле не кратно 16), после этого скрипт ожидает ещё два запроса от устройства, на каждый из которых отправляет 256 нулевых байтов  (чтобы полностью очистить кольцевой буфер устройства, который в данной реализации имеет размер 512 байтов) и завершает работу. При зацикленном воспроизведении в блок данных следом за последним фреймом записывается ```loop_frame``` и последующие за ним.
